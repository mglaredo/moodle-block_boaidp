<?PHP

/*
 * +----------------------------------------------------------------------+
 * | PHP Version 5                                                        |
 * +----------------------------------------------------------------------+
 * | Copyright (c) 2011 Miguel Gonzalez Laredo                            |
 * |                    mglaredo@ugr.es                                   |
 * |                    University of Granada                             |
 * |                                                                      |
 * | boaidp -- A Moodle Block for generating and editing                  | 
 * |           Course's Metadata for Data Providers by version OAI v2.0   |
 * |                                                                      |
 * | This is free software; you can redistribute it and/or modify it under|
 * | the terms of the GNU General Public License as published by the      |
 * | Free Software Foundation; either version 2 of the License, or (at    |
 * | your option) any later version.                                      |
 * | This software is distributed in the hope that it will be useful, but |
 * | WITHOUT  ANY WARRANTY; without even the implied warranty of          |
 * | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the         |
 * | GNU General Public License for more details.                         |     
 * |                                                                      |
 * | You should have received a copy of the GNU General Public License    |
 * | along with software.                                                 |
 * | If not, see http://opensource.org/licenses/gpl-3.0.html.             |
 * |                                                                      |
 * +----------------------------------------------------------------------+
 * @copyright Copyright (c) 2011 Miguel Gonzalez Laredo. Virtual Learning Center CEVUG, University of Granada
 * @license    http://opensource.org/licenses/gpl-3.0.html     GNU Public License
 * @author Miguel Gonzalez Laredo, mglaredo@ugr.es                     
 */

?>



<?php

require_once('block_boaidp.php');
$boaidp = new block_boaidp();

$q='';

//$bname = 'block_boaidp';
$bname = $boaidp->bname;

   // Preventing use of variables not setted
   init_fields($this->config);  
?>

<!--table style="border-spacing:20px;"-->
<table cellpadding="9" >
 <tr valign="top" >
    <td align="right"> <?php print_string('new_multiple_value', $bname); ?> </td>    <td> <?php choose_from_menu(format_multiselector($boaidp, $this->config), 'new_multiple_value'/*, $this->config->new_multiple_value*/); ?> </td>
    <td align="center"> <input type="submit" value="<?php print_string('continue') ?>" /></td> 
 </tr>    
</table>
<p></p>
 <hr /> 

<table cellpadding="9" >

    <tr valign="top">
    <td align="right"> <?php print_string('id', $bname); ?>:</td>    <td> <?php echo $this->config->id; ?> </td>
  </tr>
  <tr valign="top">
    <td align="right"> <?php print_string('url', $bname); ?>:</td>    <td> <?php echo $this->config->url; ?> </td>
  </tr>
  <tr valign="top">
    <td align="right"> <?php print_string('provider', $bname); ?>:</td>    <td> <?php echo $this->config->provider; ?> </td>
  </tr>
  <tr valign="top">
    <td align="right"> <?php print_string('enterdate', $bname); ?>:</td>    <td> <?php echo $this->config->enterdate; ?> </td>
  </tr>
  <? echo format_tf('oai_set', 'oai_set', $bname, $this->config->oai_set); ?> 
  <? echo format_tf('oai_identifier', 'oai_identifier', $bname, $this->config->oai_identifier); ?> 
  
  <tr valign="top">
    <td align="right"> <?php print_string('datestamp', $bname); ?>:</td>    <td> <?php echo $this->config->datestamp; ?> </td>
  </tr>
  <tr valign="top">
    <td align="right"> <?php print_string('deleted', $bname); ?>:</td>    <td> <?php choose_from_menu(array("true" => "true", "false" => "false"),'deleted',$this->config->deleted); ?> </td>
  </tr>
  
  <? echo format_md_edition($boaidp, $this->config); ?>
  <!--? echo format_multiselector($boadip, $this->config); ?-->
 
  <tr>
    <td colspan="2" align="center"> <input type="submit" value="<?php print_string('savechanges') ?>" /></td>
  </tr>
</table>


 

   
 
<!--?php use_html_editor(); ?-->
<? 

    /**
    * Initialization of editable fields if empty 
    *
    * @param	object	&$obj Target object passed by reference
    */
    function init_fields(&$obj)
    {
        if (!isset($obj->new_multiple_value)) {
            $obj->new_multiple_value = '';
        }
        if (!isset($obj->id)) {
           $obj->id = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->url)) {
           $obj->url = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->provider)) {
           $obj->provider = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->enterdate)) {
           $obj->enterdate = get_string("not_setted","block_boaidp");
        }        
        if (!isset($obj->oai_identifier)) {
           $obj->oai_identifier = get_string("not_setted","block_boaidp");
        }  
        if (!isset($obj->oai_set)) {
           $obj->oai_set = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->datestamp)) {
           $obj->datestamp = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->deleted)) {
           $obj->deleted = false;
        }   
        if (!isset($obj->dc_title)) {
           $obj->dc_title = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_date)) {
           $obj->dc_date = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_creator)) {
           $obj->dc_creator = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_subject)) {
           $obj->dc_subject = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_description)) {
           $obj->dc_description = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_contributor)) {
           $obj->dc_contributor = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_publisher)) {
           $obj->dc_publisher = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_type)) {
           $obj->dc_type = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_format)) {
           $obj->dc_format = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_identifier)) {
           $obj->dc_identifier = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_source)) {
           $obj->dc_source = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_language)) {
           $obj->dc_language = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_relation)) {
           $obj->dc_relation = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_coverage)) {
           $obj->dc_coverage = get_string("not_setted","block_boaidp");
        }
        if (!isset($obj->dc_rights)) {
           $obj->dc_rights = get_string("not_setted","block_boaidp");
        }
        
        return true;
    } 
    
    /**
    * HTML output for textfield fields 
    *
    * HTML output for textfield fields
    * @param	object	&$obj Target object passed by reference
    */
    function format_tf($label_name, $ctrl_id, $block_name, $current_value, $size=50, $max_size=255){
        $html_output = '<tr valign="top"> <td align="right">';
        $html_output .= $label_name.':</td>    <td> '.print_textfield($ctrl_id, $current_value, '', $size, $max_size, true);
        $html_output .= '</td>  </tr>';
        
        return $html_output;
    }
    
    
    /**
    * HTML output for metadata edition section
    *
    * HTML output for textfield fields
    * @param	object	&$obj Target object passed by reference
    */
    function format_md_edition($b_obj, $data_obj){
        global  $COURSE;
        
        $html_output = '';
        
        $q = '';
        $tabs =  $b_obj->pre.$b_obj->instance->fld_tab.' fld,'.$b_obj->pre.$b_obj->instance->mv_tab.' mv ';
        
        $fields = $b_obj->boaidp_get_FieldsValuesForSchema(&$q, $tabs,'fld.id=mv.field_id','mv.provider='.$COURSE->id,null,'mv.id, fld.schema_id, fld.name, mv.value');  
 
        if ($fields){ // If not FALSE the result
            foreach ($fields as $sch=>$flds)
            {
                $id = strval($flds->id);
                $name =  strval($flds->name);
                $value =  strval($flds->value);
                //echo $name.' <<--.-->>'.$value;

                $html_output .= format_tf($name, $b_obj->ctrl_prefix.$id, $b_obj->bname, $value);
            }
        }
        
        return $html_output;
    
    }

    function  format_multiselector($b_obj, $data_obj){
        global  $COURSE;
        
        $multiFields = false;
        $menu_array = array();
        
        $q = '';
        $tabs =  $b_obj->pre.$b_obj->instance->fld_tab.' fld';

        $multiFields = $b_obj->boaidp_get_FieldsForSchema($q,$tabs,'fld.ismultiple=1',null,'fld.name,fld.id');
//var_dump($multiFields); echo("<br/><br/><br/>");
 
        if ($multiFields){ // If not FALSE the result
            foreach ($multiFields as $row)
            {
                $menu_array[$row->id] = $row->name;
            }
        }/*else { 
            $menu_array = array("bad query"=>"bad");
        }*/
//var_dump($menu_array); 
        return $menu_array;
    }
    
?>
